# Исправление бага с извлечением дисков из проигрывателя

## Проблема

При извлечении кастомного диска из проигрывателя с непустой рукой:
- Диск выпадает как обычный предмет (ванильное поведение)
- Музыка продолжает играть
- Остановить воспроизведение невозможно даже разрушением проигрывателя

## Причина

В `JukeboxEventHandler.onUseBlock()` была логика, которая обрабатывала извлечение диска только при клике **пустой рукой**:

```java
// Старый код - обрабатывал только пустую руку
if (!currentDisc.isEmpty() && heldItem.isEmpty()) {
    return handleDiscRemoval(player, (ServerWorld) world, pos, jukebox, currentDisc);
}
```

Когда игрок кликал **непустой рукой**, управление передавалось ванильной логике Minecraft, которая:
1. Извлекала диск из проигрывателя
2. Выбрасывала его как обычный предмет
3. **НЕ уведомляла** наш мод об остановке воспроизведения

## Решение

### 1. Обновлена логика обработки кликов

```java
// Новый код - обрабатывает любой клик по проигрывателю с диском
if (!currentDisc.isEmpty()) {
    return handleDiscRemoval(player, (ServerWorld) world, pos, jukebox, currentDisc, heldItem.isEmpty());
}
```

### 2. Обновлен метод handleDiscRemoval

Добавлен параметр `handWasEmpty` для различения двух случаев:

```java
private static ActionResult handleDiscRemoval(net.minecraft.entity.player.PlayerEntity player, ServerWorld world,
                                             BlockPos pos, JukeboxBlockEntity jukebox, ItemStack currentDisc, boolean handWasEmpty) {
    
    // Всегда останавливаем воспроизведение
    PlaybackManager playbackManager = Audio_disc.getPlaybackManager();
    if (playbackManager != null) {
        playbackManager.stopPlayback(pos);
    }

    if (handWasEmpty) {
        // Рука была пустая - полностью обрабатываем извлечение сами
        jukebox.setStack(ItemStack.EMPTY);
        
        if (!player.getInventory().insertStack(currentDisc)) {
            player.dropItem(currentDisc, false);
        }
        
        return ActionResult.SUCCESS;
    } else {
        // Рука была не пустая - останавливаем музыку и позволяем ванили обработать извлечение
        return ActionResult.PASS;
    }
}
```

## Логика работы

### Случай 1: Клик пустой рукой
1. Останавливаем воспроизведение через `PlaybackManager.stopPlayback()`
2. Извлекаем диск из проигрывателя
3. Помещаем диск в инвентарь игрока (или выбрасываем при заполненном инвентаре)
4. Возвращаем `ActionResult.SUCCESS` (ванильная логика не выполняется)

### Случай 2: Клик непустой рукой
1. Останавливаем воспроизведение через `PlaybackManager.stopPlayback()`
2. Возвращаем `ActionResult.PASS` (позволяем ванильной логике обработать извлечение)
3. Ванильная логика извлекает диск и выбрасывает его как предмет

## Результат

Теперь в обоих случаях:
- ✅ Музыка корректно останавливается
- ✅ Диск извлекается из проигрывателя
- ✅ Нет "зависших" воспроизведений

## Тестирование

Для проверки исправления:

1. **Тест с пустой рукой:**
   - Поместите кастомный диск в проигрыватель
   - Убедитесь, что музыка играет
   - Кликните по проигрывателю пустой рукой
   - ✅ Музыка должна остановиться, диск попасть в инвентарь

2. **Тест с непустой рукой:**
   - Поместите кастомный диск в проигрыватель
   - Убедитесь, что музыка играет
   - Возьмите любой предмет в руку
   - Кликните по проигрывателю
   - ✅ Музыка должна остановиться, диск выпасть как предмет

3. **Тест разрушения проигрывателя:**
   - Поместите кастомный диск в проигрыватель
   - Убедитесь, что музыка играет
   - Разрушьте проигрыватель
   - ✅ Музыка должна остановиться (это уже работало)

## Файлы изменены

- `src/main/java/org/stepan/audio_disc/events/JukeboxEventHandler.java`
  - Обновлена логика в методе `onUseBlock()`
  - Обновлен метод `handleDiscRemoval()` с новым параметром